<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YouToFlix - ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶®‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</title>
  
  <style>
    /* General Body and Theme Styles */
    body{margin:0;font-family:'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background-color:#f9f9f9;color:#030303;transition:background-color .3s,color .3s}
    body.dark-mode{background-color:#0f0f0f;color:#f1f1f1}
    main{padding:1.5rem;min-height:calc(100vh - 150px)}
    
    /* Header Styles */
    header{background-color:#fff;color:#030303;padding:.5rem 1rem;min-height:56px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:1002;border-bottom:1px solid rgba(0,0,0,.1)}
    body.dark-mode header{background-color:#212121;border-bottom:1px solid rgba(255,255,255,.1)}
    #menu-icon{width:28px;height:28px;cursor:pointer;fill:#030303}
    body.dark-mode #menu-icon{fill:#fff}
    header h1{margin:0;font-size:1.8rem;font-weight:600;white-space:nowrap;position:absolute;left:50%;transform:translateX(-50%);color:#ff0000;font-family:'Oswald', sans-serif;}
    #theme-toggle{cursor:pointer;width:24px;height:24px}
    #theme-toggle .sun-icon, #theme-toggle .moon-icon{width:100%;height:100%;fill:#030303}
    body.dark-mode #theme-toggle .sun-icon, body.dark-mode #theme-toggle .moon-icon{fill:#fff}
    .moon-icon{display:none}
    body.dark-mode .sun-icon{display:none}
    body.dark-mode .moon-icon{display:block}
    
    /* Navigation Menu Styles */
    nav{position:fixed;top:0;left:0;width:260px;height:100vh;background:#fff;box-shadow:2px 0 5px rgba(0,0,0,.2);flex-direction:column;justify-content:flex-start;padding-top:70px;transform:translateX(-100%);transition:transform .3s ease-in-out;z-index:1000;overflow-y:auto}
    body.dark-mode nav{background:#212121}
    nav.nav-open{transform:translateX(0)}
    nav a{color:#030303;text-decoration:none;font-weight:500;font-size:.9rem;padding:.7rem 1.5rem;display:block;transition:background-color .2s}
    body.dark-mode nav a{color:#fff}
    nav a:hover{background-color:rgba(0,0,0,.05)}
    body.dark-mode nav a:hover{background-color:rgba(255,255,255,.1)}
    .nav-group{border-bottom:1px solid #e0e0e0}
    body.dark-mode .nav-group{border-bottom:1px solid #3f3f3f}
    .nav-group-header{padding:1rem 1.5rem;font-weight:700;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .nav-group-header .arrow{transition:transform .2s}
    .nav-group-header.open .arrow{transform:rotate(180deg)}
    .nav-links{display:none;padding-left:1rem;background-color:rgba(0,0,0,0.02)}
    body.dark-mode .nav-links{background-color:rgba(255,255,255,0.03)}
    .nav-group-header.open + .nav-links{display:block}
    #saved-videos-link{position:sticky;bottom:0;background:inherit;border-top:2px solid #e0e0e0;font-weight:bold;}
    body.dark-mode #saved-videos-link{border-top:2px solid #3f3f3f;}
    
    /* Main Content & Video Grid Styles */
    .title-container{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #ccc;margin-bottom:1.5rem}
    body.dark-mode .title-container{border-bottom-color:#4d4d4d}
    .category-title{font-size:1.8rem;font-weight:700}
    #refresh-button{width:28px;height:28px;cursor:pointer;fill:#606060;transition:transform .3s ease}
    #refresh-button:hover{transform:rotate(90deg)}
    body.dark-mode #refresh-button{fill:#aaa}
    .video-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.5rem}
    .video-card{background-color:transparent;display:flex;flex-direction:column}
    .thumbnail-container{position:relative;cursor:pointer;width:100%;padding-top:56.25%;border-radius:12px;overflow:hidden;background-color:#000;}
    .thumbnail-container img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;transition:transform .2s}
    .thumbnail-container:hover img{transform:scale(1.1)}
    .video-player{position:absolute;top:0;left:0;width:100%;height:100%;border:none;border-radius:12px}
    .video-info{padding:.8rem 0;display:flex;flex-direction:column;flex-grow:1;}
    .video-title{font-size:1rem;font-weight:500;margin:0 0 .5rem 0;line-height:1.4;min-height:2.8rem; overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .card-actions{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:auto;}
    .action-btn{background:none;border:none;cursor:pointer;padding:5px;display:flex;align-items:center;gap:5px;font-size:0.8rem;color:#606060;transition:color .2s;}
    body.dark-mode .action-btn{color:#aaa;}
    .action-btn svg{width:22px;height:22px;fill:#606060;transition:fill .2s, transform .2s;}
    body.dark-mode .action-btn svg{fill:#aaa;}
    .action-btn:hover svg{transform:scale(1.1);}
    .action-btn.love-btn.loved svg{fill:#ff0000;}
    .action-btn.save-btn.saved svg{fill:#007bff;}
    .empty-category-message {grid-column:1 / -1; text-align:center; padding:2rem; background-color:#f2f2f2; border-radius:8px; color:#606060;}
    body.dark-mode .empty-category-message {background-color:#282828;color:#aaa}
    
    /* Loading Spinner & Skeletons */
    .spinner{margin:auto; border:4px solid rgba(0,0,0,.1);width:36px;height:36px;border-radius:50%;border-left-color:#ff0000;animation:spin 1s linear infinite}
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Thumbnail Specific Spinner */
    .thumbnail-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 40px;
        height: 40px;
        margin-top: -20px; /* Half of height */
        margin-left: -20px; /* Half of width */
        border-radius: 50%;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-top-color: #ff0000;
        animation: spin 1s linear infinite;
        z-index: 5;
    }
    body.dark-mode .thumbnail-spinner {
        border: 4px solid rgba(0, 0, 0, 0.2);
        border-top-color: #ff0000;
    }

    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }
    .shimmer-bg {
        animation: shimmer 2s infinite linear;
        background: linear-gradient(to right, #e0e0e0 4%, #f0f0f0 25%, #e0e0e0 36%);
        background-size: 1000px 100%;
    }
    body.dark-mode .shimmer-bg {
        background: linear-gradient(to right, #2c2c2c 4%, #3a3a3a 25%, #2c2c2c 36%);
        background-size: 1000px 100%;
    }
    .video-card-skeleton { display: flex; flex-direction: column; gap: 10px; }
    .skeleton-thumbnail { width: 100%; padding-top: 56.25%; border-radius: 12px; }
    .skeleton-info { display: flex; flex-direction: column; gap: 8px; padding-top: 8px; }
    .skeleton-text { height: 20px; border-radius: 4px; }
    .skeleton-text.short { width: 60%; }
    .loading-more-container { grid-column: 1 / -1; display: flex; justify-content: center; padding: 2rem; }

    /* Floating Video Player Styles */
    #floating-video-container {
        position: fixed;
        bottom: 15px;
        right: 15px;
        width: 300px;
        max-width: 80vw;
        z-index: 2000;
        overflow: hidden;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: none;
        transform: scale(0);
        transform-origin: bottom right;
        transition: transform 0.3s ease-in-out;
        background-color: #000;
        cursor: pointer;
    }
    #floating-video-container.show {
        display: block;
        transform: scale(1);
    }
    #floating-video-player {
        width: 100%;
        height: auto;
        aspect-ratio: 16 / 9;
    }
    #close-floating-video {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 24px;
        height: 24px;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        z-index: 2001;
    }
    /* Hide floating player on desktop */
    @media (min-width: 769px) {
      #floating-video-container {
        display: none !important;
      }
    }
    
    /* Footer Styles */
    footer{text-align:center;padding:1.5rem;background-color:#f2f2f2;margin-top:2rem}
    body.dark-mode footer{background-color:#212121}
  </style>
</head>
<body>
  <header>
    <svg id="menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6h18v2H3V6z M3,11h18v2H3v-2z M3,16h18v2H3v-2z"/></svg>
    <h1 id="animated-title">YouToFlix</h1>
    <div id="theme-toggle">
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5S14.76,7,12,7z M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9z M2,12c0,0.55,0.45,1,1,1h1c0.55,0,1-0.45,1-1s-0.45-1-1-1H3C2.45,11,2,11.45,2,12z M19,11h-1c-0.55,0-1,0.45-1,1s0.45,1,1,1h1c0.55,0,1-0.45,1-1S19.55,11,19,11z M11,2v1c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,19v1c0,0.55,0.45,1,1,1s1-0.45,1-1v-1c0-0.55-0.45-1-1-1S11,18.45,11,19z M5.64,4.22c-0.39-0.39-1.02-0.39-1.41,0c-0.39,0.39-0.39,1.02,0,1.41l1.06,1.06c0.39,0.39,1.02,0.39,1.41,0s0.39-1.02,0-1.41L5.64,4.22z M16.97,15.56c-0.39-0.39-1.02-0.39-1.41,0c-0.39,0.39-0.39,1.02,0,1.41l1.06,1.06c0.39,0.39,1.02,0.39,1.41,0s0.39-1.02,0-1.41L16.97,15.56z M4.22,16.97c0.39,0.39,1.02,0.39,1.41,0l1.06-1.06c0.39-0.39,0.39-1.02,0-1.41s-1.02-0.39-1.41,0L4.22,15.56C3.83,15.95,3.83,16.58,4.22,16.97z M18.38,5.64c0.39-0.39,1.02-0.39,1.41,0c0.39,0.39,0.39,1.02,0,1.41l-1.06,1.06c-0.39,0.39-1.02,0.39-1.41,0s-0.39-1.02,0-1.41L18.38,5.64z"/></svg>
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.3,4.84C11.32,4.46,10.22,4.5,9.23,4.9C6.41,6.1,4.94,8.96,5.96,11.77c0.8,2.18,2.89,3.67,5.2,3.84c3.08,0.23,5.83-1.8,6.59-4.6c0.3-1.12,0.1-2.28-0.56-3.26c-0.78-1.17-2.05-1.92-3.41-1.93C13.23,5.85,12.75,5.39,12.3,4.84z"/></svg>
    </div>
  </header>
  
  <nav id="nav-menu">
      <a href="#" data-category="All">üè† Home</a>
      <div class="nav-group">
          <div class="nav-group-header">Indian Cinema <span class="arrow">‚ñº</span></div>
          <div class="nav-links">
              <a href="#" data-category="Bollywood">Bollywood</a><a href="#" data-category="Tollywood">Tollywood</a><a href="#" data-category="Kollywood">Kollywood</a><a href="#" data-category="Mollywood">Mollywood</a><a href="#" data-category="Lollywood">Lollywood</a>
          </div>
      </div>
      <div class="nav-group">
          <div class="nav-group-header">International Cinema <span class="arrow">‚ñº</span></div>
          <div class="nav-links">
              <a href="#" data-category="Hollywood">Hollywood</a><a href="#" data-category="Dhallywood">Dhallywood</a><a href="#" data-category="Chinawood">Chinawood</a><a href="#" data-category="Nollywood">Nollywood</a><a href="#" data-category="K-Cinema">K-Cinema</a><a href="#" data-category="Turkish Cinema">Turkish Cinema</a>
          </div>
      </div>
      <div class="nav-group">
          <div class="nav-group-header">Drama Series <span class="arrow">‚ñº</span></div>
          <div class="nav-links">
              <a href="#" data-category="Bangla Drama">Bangla Drama</a><a href="#" data-category="Urdu Drama">Urdu Drama</a><a href="#" data-category="Hindi Drama">Hindi Drama</a><a href="#" data-category="Turki Drama">Turkish Drama</a>
          </div>
      </div>
      <div class="nav-group">
          <div class="nav-group-header">Cartoon & Anime <span class="arrow">‚ñº</span></div>
          <div class="nav-links">
              <a href="#" data-category="Bangla Carton">Bangla Carton</a><a href="#" data-category="Hindi Carton">Hindi Carton</a><a href="#" data-category="English Carton">English Carton</a>
          </div>
      </div>
      <a href="developer.html">üßë‚Äçüíª About</a>
      <a href="#" data-category="Saved" id="saved-videos-link">üîñ Saved Videos</a>
  </nav>

  <main>
    <div class="video-section-container">
      <div class="title-container">
        <h2 id="video-section-title" class="category-title"></h2>
        <svg id="refresh-button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.65,6.35C16.2,4.9,14.21,4,12,4c-4.42,0-7.99,3.58-7.99,8s3.57,8,7.99,8c3.73,0,6.84-2.55,7.73-6h-2.08c-0.82,2.33-3.04,4-5.65,4-3.31,0-6-2.69-6-6s2.69-6,6-6c1.66,0,3.14,0.69,4.22,1.78L13,11h7V4L17.65,6.35z"/></svg>
      </div>
      <div id="main-video-grid" class="video-grid">
        <!-- ‡¶™‡ßç‡¶∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡ßç‡¶ï‡ßá‡¶≤‡¶ø‡¶ü‡¶® ‡¶≤‡ßã‡¶°‡¶æ‡¶∞ -->
        <script>
            for (let i = 0; i < 10; i++) {
                document.write(`
                    <div class="video-card-skeleton">
                        <div class="skeleton-thumbnail shimmer-bg"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-text shimmer-bg"></div>
                            <div class="skeleton-text short shimmer-bg"></div>
                        </div>
                    </div>
                `);
            }
        </script>
      </div>
    </div>
  </main>
  
  <footer><p>¬© 2025 YouToFlix. ‡¶∏‡¶∞‡ßç‡¶¨‡¶∏‡ßç‡¶¨‡¶§‡ßç‡¶¨ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§‡•§</p></footer>
  
  <!-- ‡¶≠‡¶æ‡¶∏‡¶Æ‡¶æ‡¶® ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ -->
  <div id="floating-video-container">
    <button id="close-floating-video">X</button>
    <div id="floating-video-player"></div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD6y6DjbCt9qUMKNZ1oIZYHWAUoishDK4Q",
      authDomain: "youtoflix-2e613.firebaseapp.com",
      databaseURL: "https://youtoflix-2e613-default-rtdb.firebaseio.com",
      projectId: "youtoflix-2e613",
      storageBucket: "youtoflix-2e613.firebasestorage.app",
      messagingSenderId: "1021832895783",
      appId: "1:1021832895783:web:6bede10ea3e5c2d2505d02"
    };

    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let allVideosData = [], videosToDisplayList = [], players = {}, currentCategory = "All", videosDisplayedCount = 0, videosPerLoad = 10, isLoading = false;
    let isApiReady = false, isDataReady = false;
    
    const mainGrid = document.getElementById("main-video-grid");
    const sectionTitle = document.getElementById("video-section-title");
    const navMenu = document.getElementById("nav-menu");
    const refreshButton = document.getElementById("refresh-button");
    
    // Floating Video Variables
    let floatingPlayer = null, currentFloatingVideoId = null, originalPlayerContainer = null;
    let intersectionObserver = null;
    const floatingContainer = document.getElementById('floating-video-container');
    const floatingPlayerDiv = document.getElementById('floating-video-player');
    const closeFloatingBtn = document.getElementById('close-floating-video');

    const categoryInfo = {
        All: "‡¶∏‡¶ï‡¶≤ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì", Saved: "üîñ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì", Hollywood: "Hollywood Movies", Bollywood: "Bollywood Movies", Tollywood: "Tollywood Movies", Dhallywood: "Dhallywood Movies", Kollywood: "Kollywood Movies", Mollywood: "Mollywood Movies", Lollywood: "Lollywood Movies", Chinawood: "Chinese Cinema", Nollywood: "Nollywood Movies", "K-Cinema": "Korean Cinema", "Turkish Cinema": "Turkish Cinema", "Bangla Drama": "Bangla Drama", "Urdu Drama": "Urdu Drama", "Hindi Drama": "Hindi Drama", "Turki Drama": "Turkish Drama", "Bangla Carton": "Bangla Carton", "Hindi Carton": "Hindi Carton", "English Carton": "English Carton"
    };

    // Helper Functions
    const getStoredObject = key => { try { const item = localStorage.getItem(key); const parsed = JSON.parse(item || '{}'); return (typeof parsed === 'object' && !Array.isArray(parsed) && parsed !== null) ? parsed : {}; } catch (e) { return {}; } };
    const getStoredArray = key => { try { const item = localStorage.getItem(key); const parsed = JSON.parse(item || '[]'); return Array.isArray(parsed) ? parsed : []; } catch (e) { return []; } };
    const setStoredJson = (key, data) => localStorage.setItem(key, JSON.stringify(data));
    const getVideoId = url => { try { if(!url) return null; return url.includes("watch") ? new URL(url).searchParams.get("v") : new URL(url).pathname.substring(1); } catch (e) { return null; } };
    
    // Floating Player Functions
    function destroyFloatingPlayer() {
        if (floatingPlayer) {
            floatingPlayer.destroy();
            floatingPlayer = null;
        }
        if (originalPlayerContainer) {
            const videoId = originalPlayerContainer.dataset.videoId;
            const title = originalPlayerContainer.dataset.title;
            originalPlayerContainer.innerHTML = `<img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" alt="${title}" loading="lazy" onerror="this.parentElement.innerHTML = '<p style=\'color:red;padding:1rem;\'>‡¶•‡¶æ‡¶Æ‡ßç‡¶¨‡¶®‡ßá‡¶á‡¶≤ ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø‡•§</p>';">`;
        }
        floatingContainer.classList.remove('show');
        currentFloatingVideoId = null;
        originalPlayerContainer = null;
        if(intersectionObserver) intersectionObserver.disconnect();
    }
    
    function createFloatingPlayer(originalPlayer) {
        if (currentFloatingVideoId) destroyFloatingPlayer();
        
        const videoId = originalPlayer.getVideoData().video_id;
        const currentTime = originalPlayer.getCurrentTime();
        
        currentFloatingVideoId = videoId;
        originalPlayerContainer = originalPlayer.getIframe().closest('.thumbnail-container');

        originalPlayer.pauseVideo();
        originalPlayer.getIframe().style.display = 'none';
        
        floatingContainer.classList.add('show');
        
        floatingPlayer = new YT.Player(floatingPlayerDiv, {
            videoId: videoId,
            playerVars: { 
                'rel': 0,
                'start': Math.floor(currentTime) 
            },
            events: {
                'onReady': function(event) {
                    event.target.playVideo(); 
                },
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function observeVideoForFloating(player) {
        if (intersectionObserver) intersectionObserver.disconnect();
        
        const videoCard = player.getIframe().closest('.video-card');
        if (!videoCard) return;

        intersectionObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (!entry.isIntersecting && player.getPlayerState() === YT.PlayerState.PLAYING) {
                    createFloatingPlayer(player);
                    intersectionObserver.disconnect();
                }
            });
        }, { threshold: 0.5 });

        intersectionObserver.observe(videoCard);
    }
    
    function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.PLAYING) {
            if (floatingPlayer && event.target !== floatingPlayer) {
                destroyFloatingPlayer();
            }
            for (const playerId in players) {
                if (players[playerId] && players[playerId] !== event.target && typeof players[playerId].pauseVideo === 'function') {
                    players[playerId].pauseVideo();
                }
            }
            if (floatingPlayer && event.target === floatingPlayer) {
                 for (const playerId in players) {
                    if (players[playerId] && typeof players[playerId].pauseVideo === 'function') {
                        players[playerId].pauseVideo();
                    }
                 }
            }
            if (!floatingPlayer && window.innerWidth <= 768) {
                const isOriginalPlayer = event.target.getIframe().closest('.video-card');
                if (isOriginalPlayer) {
                    observeVideoForFloating(event.target);
                }
            }
        }
    }
    
    function handleFloatingPlayerDoubleClick() {
        if (!floatingPlayer || !originalPlayerContainer || !currentFloatingVideoId) return;

        const videoId = currentFloatingVideoId;
        const currentTime = floatingPlayer.getCurrentTime();
        const targetContainer = originalPlayerContainer;
        const playerDivId = `player-${videoId}`;
        
        destroyFloatingPlayer();
        targetContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });

        setTimeout(() => {
            targetContainer.innerHTML = `<div id="${playerDivId}" class="video-player"></div>`;
            
            players[playerDivId] = new YT.Player(playerDivId, {
                videoId: videoId,
                playerVars: { 'autoplay': 1, 'rel': 0 },
                events: {
                    'onReady': (event) => {
                        event.target.seekTo(currentTime, true);
                        event.target.playVideo();
                    },
                    'onStateChange': onPlayerStateChange
                }
            });
        }, 300);
    }

    // Core App Functions
    function handleLove(video, loveBtn, countEl) {
        const lovedVideos = getStoredObject('lovedVideos');
        const isLoved = !!lovedVideos[video.id];
        db.ref(`videos/${video.id}/loves`).transaction(currentLoves => isLoved ? (currentLoves || 1) - 1 : (currentLoves || 0) + 1);
        if (isLoved) delete lovedVideos[video.id];
        else lovedVideos[video.id] = true;
        setStoredJson('lovedVideos', lovedVideos);
        loveBtn.classList.toggle('loved', !isLoved);
        if(countEl) {
            const currentCount = parseInt(countEl.textContent, 10);
            countEl.textContent = isLoved ? currentCount - 1 : currentCount + 1;
        }
    }

    function handleSave(video, saveBtn) {
        let savedVideos = getStoredArray('savedVideos');
        const isSaved = savedVideos.includes(video.id);
        if (isSaved) savedVideos = savedVideos.filter(id => id !== video.id);
        else savedVideos.push(video.id);
        setStoredJson('savedVideos', savedVideos);
        saveBtn.classList.toggle('saved', !isSaved);
    }

    function createVideoCard(video) {
        const videoCard = document.createElement('div');
        videoCard.className = 'video-card';
        try {
            const videoId = getVideoId(video.link);
            if (!videoId) throw new Error("Invalid video link.");
            
            const title = video.title || "‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø";
            const lovedVideos = getStoredObject('lovedVideos');
            const savedVideos = getStoredArray('savedVideos');

            videoCard.innerHTML = `
                <div class="real-content">
                    <div class="thumbnail-container" data-video-id="${videoId}" data-title="${title.replace(/"/g, '"')}">
                        <img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" alt="${title}" loading="lazy" onerror="this.parentElement.innerHTML = '<p style=\'color:red;padding:1rem;\'>‡¶•‡¶æ‡¶Æ‡ßç‡¶¨‡¶®‡ßá‡¶á‡¶≤ ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø‡•§</p>';">
                    </div>
                    <div class="video-info">
                        <h3 class="video-title">${title}</h3>
                        <div class="card-actions">
                            <button class="action-btn love-btn ${lovedVideos[video.id] ? 'loved' : ''}">
                                <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg> 
                                <span class="love-count">${video.loves || 0}</span>
                            </button>
                            <button class="action-btn save-btn ${savedVideos.includes(video.id) ? 'saved' : ''}">
                                <svg viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z"/></svg>
                                <span>Save</span>
                            </button>
                        </div>
                    </div>
                </div>`;
            
            const loveBtn = videoCard.querySelector('.love-btn');
            const loveCountEl = videoCard.querySelector('.love-count');
            loveBtn.onclick = () => handleLove(video, loveBtn, loveCountEl);

            const saveBtn = videoCard.querySelector('.save-btn');
            saveBtn.onclick = () => handleSave(video, saveBtn);

            videoCard.querySelector('.thumbnail-container').addEventListener('click', (e) => {
                const thumb = e.currentTarget;
                if(thumb.querySelector('iframe') || thumb.querySelector('.thumbnail-spinner')) return; 

                if (currentFloatingVideoId === videoId) {
                    handleFloatingPlayerDoubleClick();
                    return;
                }
                
                const playerDivId = `player-${video.id}`;
                thumb.innerHTML = `
                    <div class="thumbnail-spinner"></div>
                    <div id="${playerDivId}" class="video-player"></div>
                `;
                
                players[playerDivId] = new YT.Player(playerDivId, {
                    videoId: videoId,
                    playerVars: { 'autoplay': 1, 'rel': 0 },
                    events: {
                        'onReady': (event) => {
                            const spinner = thumb.querySelector('.thumbnail-spinner');
                            if(spinner) spinner.style.display = 'none';
                        },
                        'onStateChange': onPlayerStateChange
                    }
                });
            });
            
        } catch (error) {
            console.error('Card render failed:', video.link, error);
            videoCard.innerHTML = `<div class="video-info"><h3 class="video-title" style="color:red;">‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡¶ü‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</h3><p style="font-size:0.8rem;color:#999;">‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶ï‡¶æ‡¶∞‡¶£: ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§</p></div>`;
        }
        return videoCard;
    }
    
    function loadMoreVideos(){
        if(isLoading) return;
        isLoading = true;

        const videosToLoad = videosToDisplayList.slice(videosDisplayedCount, videosDisplayedCount + videosPerLoad);
        
        if (videosToLoad.length === 0) {
            if (videosDisplayedCount === 0) {
                mainGrid.innerHTML = `<p class="empty-category-message">‡¶è‡¶á ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>`;
            }
            isLoading = false;
            return;
        }

        videosToLoad.forEach(video => {
            const cardElement = createVideoCard(video);
            mainGrid.appendChild(cardElement);
        });

        videosDisplayedCount += videosToLoad.length;
        isLoading = false;
    }
    
    function setupCategoryView(category) {
        currentCategory = category;
        mainGrid.innerHTML = "";
        players = {};
        videosDisplayedCount = 0;
        sectionTitle.innerText = categoryInfo[category] || "‡¶≠‡¶ø‡¶°‡¶ø‡¶ì‡¶∏‡¶Æ‡ßÇ‡¶π";
        if(floatingPlayer) destroyFloatingPlayer();

        const shuffleArray = arr => arr.slice().sort(() => Math.random() - 0.5);

        if (category === 'Saved') {
            const savedVideoIds = getStoredArray('savedVideos');
            videosToDisplayList = allVideosData.filter(v => savedVideoIds.includes(v.id)).reverse();
        } else {
            let sourceVideos = (category === 'All') 
                ? allVideosData 
                : allVideosData.filter(video => video.category === category);
            videosToDisplayList = shuffleArray(sourceVideos);
        }
        
        loadMoreVideos();
    }
    
    function startApp() {
        if (isApiReady && isDataReady) {
            mainGrid.innerHTML = ''; 
            setupCategoryView(currentCategory);
        }
    }

    // Initialization
    window.onYouTubeIframeAPIReady = function() {
        isApiReady = true;
        startApp();
    };

    document.addEventListener('DOMContentLoaded', () => {
        db.ref("videos").once("value", (snapshot) => {
            allVideosData = [];
            if(snapshot.exists()){
                snapshot.forEach((child) => {
                    allVideosData.push({ id: child.key, ...child.val() });
                });
            }
            allVideosData.reverse();
            isDataReady = true;
            startApp();
        }, (error) => {
            console.error("Firebase Read Failed:", error);
            mainGrid.innerHTML = `<p class="empty-category-message" style="color:red;">‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶®‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>`;
        });

        // Event Listeners
        window.addEventListener("scroll", () => {
            if (isLoading || videosDisplayedCount >= videosToDisplayList.length) return;
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                const spinnerId = 'loading-spinner';
                if (!document.getElementById(spinnerId)) {
                    const spinnerHTML = `<div class="loading-more-container" id="${spinnerId}"><div class="spinner"></div></div>`;
                    mainGrid.insertAdjacentHTML('beforeend', spinnerHTML);
                }
                
                setTimeout(() => {
                    loadMoreVideos();
                    const spinnerEl = document.getElementById(spinnerId);
                    if (spinnerEl) spinnerEl.remove();
                }, 500);
            }
        });

        navMenu.addEventListener("click", e => {
            const link = e.target.closest('a[data-category]');
            if(link) {
                e.preventDefault();
                setupCategoryView(link.dataset.category);
                if(navMenu.classList.contains("nav-open")) navMenu.classList.remove("nav-open");
            }
            const groupHeader = e.target.closest('.nav-group-header');
            if(groupHeader) groupHeader.classList.toggle('open');
        });
        
        refreshButton.addEventListener("click", () => {
            setupCategoryView(currentCategory);
        });
        
        const themeToggle=document.getElementById("theme-toggle"), body=document.body;
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark") body.classList.add("dark-mode");
        themeToggle.addEventListener("click",()=>{body.classList.toggle("dark-mode");localStorage.setItem("theme",body.classList.contains("dark-mode")?"dark":"light")});

        const menuIcon=document.getElementById("menu-icon");
        menuIcon.addEventListener("click",()=>navMenu.classList.toggle("nav-open"));
        document.addEventListener("click", e => {
          if(navMenu.classList.contains("nav-open") && !navMenu.contains(e.target) && !menuIcon.contains(e.target)) {
            navMenu.classList.remove("nav-open");
          }
        });

        closeFloatingBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            destroyFloatingPlayer();
        });
        floatingContainer.addEventListener('dblclick', handleFloatingPlayerDoubleClick);

    });
  </script>
</body>
</html>
